# ql repo https://github.com/RayWangQvQ/BiliBiliToolPro.git "bili_task_"
# ql repo https://github.com/zero205/JD_tencent_scf.git "jd_|jx_|getJDCookie" "backUp|icon" "^jd[^_]|USER|sendNotify|sign_graphics_validate|JDJR|JDSign" "main"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ql-cm
data:
  pan.conf: |-
    #临时网盘,用于临时下载指定目录下的资源
    server {
        listen 80;
        listen [::]:80;

        error_page 404 =200 /404.html;
        error_page 500 502 503 504 =200 /50x.html;
        location ~ /50x.html|/404.html {
            proxy_pass http://proxy-svc:8080;
        }

        location ~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md){
            return 404;
        }

        location / {
            root /ql/data/pan/;
            access_log off;
        }

    }

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ql-sts
spec:
  serviceName: ql-svc
  replicas: 1
  minReadySeconds: 5
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: ql-container
  volumeClaimTemplates:
    - metadata:
        name: ql-data
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: local-path
        resources:
          requests:
            storage: 5Gi
  template:
    metadata:
      labels:
        app: ql-container
      annotations:
        changeRollingUpdate: ${K8S_QL}
    spec:
      restartPolicy: Always
      terminationGracePeriodSeconds: 10
      volumes:
        - name: cm
          configMap:
            name: ql-cm
      initContainers:
        - name: wait-proxy
          image: alpine:latest
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              set -e
              sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
              apk add -f --no-cache curl
              maxTries=15
              while [ $maxTries -gt 0 ] && ! curl -sSf proxy-svc:8080 > /dev/null;do
                  echo '等待proxy可用'
                  sleep 1
                  maxTries=$(( $maxTries - 1 ))
              done
              if [ $maxTries -le 0 ]; then
                  echo >&2 'error: 尝试多次连接proxy服务失败'
                  exit 1
              fi
              echo 'proxy已启动'
          resources:
            requests:
              memory: 32Mi
              cpu: 50m
            limits:
              memory: 256Mi
              cpu: 500m
      containers:
        - name: ql-container
          image: whyour/qinglong:latest
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: false
          ports:
            - name: cp
              containerPort: 5700
            - name: cp-pan
              containerPort: 80
          env:
            - name: TZ
              valueFrom:
                configMapKeyRef:
                  name: global
                  key: timezone
          volumeMounts:
            - name: ql-data
              mountPath: /ql/data
            - name: cm
              mountPath: /volume/cm/
          command:
            - /bin/sh
            - -c
            - |
              mkdir -p /ql/data/pan/
              cat /volume/cm/pan.conf >> docker/front.conf
              ./docker/docker-entrypoint.sh
          livenessProbe:
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 3
            exec:
              command: ["curl", "-sf", "http://127.0.0.1:5400/api/health"]
          readinessProbe:
            initialDelaySeconds: 5
            periodSeconds: 2
            timeoutSeconds: 1
            httpGet:
              scheme: HTTP
              port: cp
          resources:
            requests:
              memory: 64Mi
              cpu: 100m
            limits:
              memory: 512Mi
              cpu: 1

---
apiVersion: v1
kind: Service
metadata:
  name: ql-svc
spec:
  selector:
    app: ql-container
  clusterIP: None
  sessionAffinity: ClientIP
  ports:
    - name: sp
      port: 5700
    - name: sp-pan
      port: 80
