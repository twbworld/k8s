---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dating-deploy
  labels:
    app: dating
spec:
  replicas: 1
  revisionHistoryLimit: 2
  minReadySeconds: 10
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: dating
  template:
    metadata:
      labels:
        app: dating
    spec:
      priorityClassName: normal-pc
      terminationGracePeriodSeconds: 30
      restartPolicy: Always
      volumes:
        - name: sqlite-data
          hostPath:
            type: DirectoryOrCreate
            path: /var/www/k8s/data/tmp/dating/tmp/
        - name: static
          hostPath:
            type: DirectoryOrCreate
            path: /var/www/k8s/data/tmp/dating/static/
        - name: config
          configMap:
            name: dating-cm
      initContainers:
        #k8s不像docker会自动将镜像内文件复制到空Volume中, 需手动
        - name: init-static
          image: ghcr.io/twbworld/dating:1.3.3
          imagePullPolicy: IfNotPresent
          resources:
            limits:
              memory: 128Mi
              cpu: 200m
          command: ["/bin/sh", "-c"]
          args:
            - |
              if [ -z "$(ls -A /data-target)" ]; then
                echo "将文件复制到空挂载目录"
                cp -r /app/static/* /data-target/
              fi
          volumeMounts:
            - name: static
              mountPath: /data-target
      containers:
        - name: dating-container
          image: ghcr.io/twbworld/dating:1.3.3
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              memory: 48Mi
              cpu: 20m
            limits:
              memory: 128Mi
              cpu: 400m
          ports:
            - name: cp
              containerPort: 80
          env:
            - name: TZ
              value: Asia/Shanghai
          volumeMounts:
            - name: sqlite-data
              mountPath: /app/tmp/
            - name: static
              mountPath: /app/static/
            - name: config
              mountPath: /volume/config/
          command:
            - /bin/sh
            - -c
            - |
              ./server -c /volume/config/config.yaml
          readinessProbe:
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 1
            httpGet:
              scheme: HTTP
              port: cp
              path: /
          livenessProbe:
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 3
            httpGet:
              scheme: HTTP
              port: cp
              path: /
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "sleep 5"]

---
apiVersion: v1
kind: Service
metadata:
  name: dating-svc
  labels:
    app: dating
spec:
  type: ClusterIP
  sessionAffinity: ClientIP
  selector:
    app: dating
  ports:
    - name: sp
      port: 80
